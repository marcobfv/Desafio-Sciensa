@page
@model EditarModel
@{
    ViewData["Title"] = "Editar Cliente";
}

<div class="row">

    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3>Contas bancárias</h3>
        </div>

        <div class="panel-body">

            <div>
                <h4>Cliente</h4>
                <p>
                    Nome: 
                    <input id="nome" placeholder="Nome" type="text" />
                </p>
                <p>
                    CPF: 
                    <input id="cpf" placeholder="CPF" type="text"  />
                </p>
                <p>
                    Endereco: 
                    <input id="endereco" placeholder="Endereço" type="text"  />
                </p>
            </div>

            <br />
            <hr />

            <div>
                <h4>Nova Conta</h4>
                <div>
                    <p>
                        Agência:
                        <input id="agencia" placeholder="Agência" type="text" />
                    </p>
                    <p>
                        Número:
                        <input id="numero" placeholder="Número" type="text" />
                    </p>
                    <p>
                        Tipo(CC/CP):
                        <input id="tipo" placeholder="Tipo" type="text" />
                    </p>
                    <p>
                        Saldo:
                        <input id="saldo" placeholder="Saldo" type="text" />
                    </p>

                    <input id="btnAdicionar" type="submit" class="btn btn-default btn-sm" value="Adicionar" />
                </div>

                <hr />
                
                <h4>Contas:</h4>
                <table class="table table-bordered" id="Table">
                    <tr>
                        <th>Agência</th>
                        <th>Número</th>
                        <th>Tipo</th>
                        <th>Saldo</th>
                        <th>Alterar</th>
                    </tr>
                </table>
            </div>

        </div>
    </div>
</div>

<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.2.0.min.js"></script>
<script>
    var idCliente = 1;

    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    function alterarConta(button_edit) {
        var row = $(button_edit).parents("tr");
        var cols = row.children("td");

        var _contaId = $($(cols[4]).children("input")[0]).data("id");

        var sendJsonData = {
            idCliente: idCliente,
            agencia: $($(cols[0]).children("input")[0]).val(),
            numero: $($(cols[1]).children("input")[0]).val(),
            tipo: $($(cols[2]).children("input")[0]).val(),
            saldo: $($(cols[3]).children("input")[0]).val(),
        };

        $.ajax({
            type: "PUT",
            url: "http://localhost:8080/api/conta/" + _contaId,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(sendJsonData),
            success: function () {
                carregarCliente();
                //alert("Cadastro efetuado com sucesso.");
                //$('#novoModal').modal('toggle');
                //document.location.reload();
            },
            error: function (error) {
                var x = error;
                alert("Conta alterada")
                //alert('Falha????' + x.responseText);
            }
        });
        carregarCliente();
    }

    function carregarCliente() {

        $.ajax({
            type: "GET",
            url: "http://localhost:8080/api/cliente/" + idCliente,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                $("#DIV").html('');
                var DIV = '';

                $("#nome").val(data.nome);
                $("#cpf").val(data.cpf);
                $("#endereco").val(data.endereco);

                carregarContas(data.contas);

                console.log(data);
            },

            failure: function (data) {
                console.log(data.responseText);
            },
            error: function (data) {

            }
        });
    }

    function carregarContas(contas) {
        $('#Table tbody').children('tr:not(:first)').remove();
        $.each(contas, function (i, item) {
                    var rows = "<tr>" +
                        "<td id='agenciatd'><input id='agencia' type='text' value='" + item.agencia + "'/></td>" +
                        "<td id='numerotd'><input id='numero' type='text' value='" + item.numero + "'/></td>" +
                        "<td id='tipotd'><input id='tipo' type='text' value='" + item.tipo + "'/></td>" +
                        "<td id='saldotd'><input id='saldo' type='text' value='" + item.saldo + "'/></td>" +
                        "<td>" +
                        "<input type='button' class='button' value='Alterar' data-id='" + item.id + "' onclick='alterarConta(this);' />" +
                        "</td>" +
                        "</tr>";
                    $('#Table').append(rows);
                });
              
    }

    $(document).ready(function () {

        idCliente = getUrlParameter('id');

        carregarCliente();

        $(window).focus(function () {
            carregarCliente();
        });

        $("#btnAdicionar").click(function () {
            var sendJsonData = {
                idCliente: idCliente,
                agencia: $("#agencia").val(),
                numero: $("#numero").val(),
                tipo: $("#tipo").val(),
                saldo: $("#saldo").val(),
            };

            $.ajax({
                type: "POST",
                url: "http://localhost:8080/api/conta",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(sendJsonData),
                success: function () {
                    carregarCliente();
                    //alert("Cadastro efetuado com sucesso.");
                    //$('#novoModal').modal('toggle');
                    //document.location.reload();
                },
                error: function (error) {
                    var x = error;
                    alert("Conta cadastrada");
                    //alert('Falha????' + x.responseText);
                }
            });
            carregarCliente();
        });
    });
</script>